---
title: "How to create open data cooking recipes"
author: "Shinya Uryu"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Create Recipes}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r}
library(odkitchen)
library(testthat)
library(skimr)
library(tidyverse)
library(magrittr)
data("catalog")
```

## Collect Data

<!--TODO: flow chart -->

### Search from e-Stat catalog

```{r}
data_url <- catalog %>% 
  filter(str_detect(title, "木材流通")) %>% 
  tidyr::unnest() %>% 
  magrittr::use_series(url)
```

長期蓄積 「主要樹種別素材生産量累年統計」需要部門別 全国(昭和35年～平成25年) 

<https://www.e-stat.go.jp/stat-search/files?page=1&layout=datalist&toukei=00500219&tstat=000001015629&cycle=0&tclass1=000001034727&second2=1>

```{r, echo = TRUE, eval = FALSE}
library(RSelenium)
eCaps <- list(chromeOptions = list(
  prefs = list(
  "profile.default_content_settings.popups" = 0L,
  "download.prompt_for_download"            = FALSE,
  "download.default_directory"              = here::here("data-raw")
  )))
data_url <- "https://www.e-stat.go.jp/stat-search/files?page=1&layout=datalist&toukei=00500219&tstat=000001015629&cycle=0&tclass1=000001034727&second2=1"
  
RSelenium::rsDriver(port = 4444L)
remDr <- remoteDriver(port = 4444L, browserName = "chrome", extraCapabilities = eCaps)

# download_estat_excel(remDr, data_url) 要素の位置が異なるので以下を実行

remDr$open()
remDr$navigate(data_url)

webElem <- remDr$findElement("css selector", "div.stat-dataset_list > div > article:nth-child(98) > div > ul > li:nth-child(2) > div:nth-child(3) > div:nth-child(4) > div")
webElem$getElementText()
childElems <- webElem$findChildElements("css selector", "span")

childElems[[1]]$clickElement()
remDr$close()
```

## Data Wrangling

### Import

```{r}
# check open excel ahead of time 
df_raw <- readxl::read_excel(
  here::here("data-raw", "f010c-003-001-000-000.xls"),
  sheet = 1, 
  range = c("A6:CA63"),
  na = c("", "…"))

test_that(
  "raw-data", {
    expect_equal(dim(df_raw), c(57, 79))
  }
)
```

### Modified raw data

```{r}
names(df_raw)

# use this!
(column_names_part1 <- names(df_raw)[!str_detect(names(df_raw), "X__")])
```

```{r}
# extract true column names
(column_names_part2 <- df_raw[1, ] %>% 
  # remove readxl defalt names
  .[1, ] %>% set_names(NULL) %>% as_vector() %>% 
  unique() %>% na.omit())
attributes(column_names_part2) <- NULL


column_names_part3 <- df_raw[2, ] %>% 
    #select_if(all_vars(!is.na(.))) %>% 
  .[1, ] %>% set_names(NULL) %>% as_vector() %>% 
  unique() %>% na.omit()
attributes(column_names_part3) <- NULL

column_names_part3 <- c(column_names_part3[length(column_names_part3)], column_names_part3[1:length(column_names_part3)- 1])


# repeat N times
# (column_names_n_times <- x %>% str_count("製材用") %>% sum())
```

```{r}
# Combine names
# dplyr::coalesce?
x <- !str_detect(names(df_raw), "X__")
x <- x %>% as.numeric()

x <- x %>% 
  str_replace("0", NA_character_)
```

```{r}
long_colnames <- c(column_names_part1[1],
  column_names_part1[2],
  paste(column_names_part1[2], column_names_part3[2:length(column_names_part3)], sep = "_"),
  rep(paste(column_names_part1[3], 
            paste(rep(column_names_part2[1:8], each = length(column_names_part3)), column_names_part3, sep = "_"), sep = "_")),
  rep(paste(column_names_part1[4], 
            paste(rep(column_names_part2[c(1, 9, 10, 8)], each = length(column_names_part3)),
            column_names_part3, sep = "_"), sep = "_")))

expect_equal(
  df_raw %>% names() %>% length(),
  long_colnames %>% length()
)
```



## Summarise and Visualization
